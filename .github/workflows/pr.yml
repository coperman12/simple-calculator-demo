# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     ðŸš€ CI/CD PIPELINE - LEARNING GUIDE                     â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  This file defines what happens when you push code to GitHub.             â•‘
# â•‘                                                                           â•‘
# â•‘  ðŸŽ¯ WHAT THIS FILE DOES:                                                  â•‘
# â•‘  1. Runs code quality checks (linting)                                    â•‘
# â•‘  2. Runs security scans                                                   â•‘
# â•‘  3. Runs your tests with coverage                                         â•‘
# â•‘  4. Generates a beautiful test report                                     â•‘
# â•‘  5. Publishes the report to the internet                                  â•‘
# â•‘                                                                           â•‘
# â•‘  ðŸ“š KEY CONCEPTS:                                                         â•‘
# â•‘  - "jobs" = Independent tasks that can run in parallel                    â•‘
# â•‘  - "steps" = Sequential commands within a job                             â•‘
# â•‘  - "needs" = Makes a job wait for other jobs to finish                    â•‘
# â•‘  - "if: always()" = Run even if previous steps failed                     â•‘
# â•‘                                                                           â•‘
# â•‘  â±ï¸  TOTAL TIME: ~2-3 minutes (parallel jobs save time!)                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸš€ PR Pipeline

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ TRIGGERS: When does this workflow run?                                      â”‚
# â”‚                                                                             â”‚
# â”‚ ðŸ’¡ WHY THESE TRIGGERS?                                                      â”‚
# â”‚ - push to main: Ensures main branch is always tested                        â”‚
# â”‚ - pull_request: Tests changes BEFORE they're merged (catch bugs early!)     â”‚
# â”‚ - workflow_dispatch: Lets you run manually from GitHub UI (for debugging)   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Click "Run workflow" button in GitHub Actions tab

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ PERMISSIONS: What can this workflow do?                                     â”‚
# â”‚                                                                             â”‚
# â”‚ ðŸ’¡ WHY PERMISSIONS MATTER:                                                  â”‚
# â”‚ - Security: Limits what the workflow can access (principle of least access) â”‚
# â”‚ - contents:read = Can read your code (needed to run tests)                  â”‚
# â”‚ - pages:write = Can publish to GitHub Pages (for test reports)              â”‚
# â”‚ - id-token:write = Needed for secure GitHub Pages deployment                â”‚
# â”‚                                                                             â”‚
# â”‚ âš ï¸  WITHOUT THESE: Workflow would fail with "permission denied" errors      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
permissions:
  contents: read
  pages: write
  id-token: write

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ CONCURRENCY: Prevent race conditions                                        â”‚
# â”‚                                                                             â”‚
# â”‚ ðŸ’¡ WHY THIS MATTERS:                                                        â”‚
# â”‚ - Imagine 2 deploys running at the same time â†’ corrupted website!           â”‚
# â”‚ - group: "pages" = All deploys share this "lock"                            â”‚
# â”‚ - cancel-in-progress: false = Let running deploys finish (don't interrupt)  â”‚
# â”‚                                                                             â”‚
# â”‚ ðŸŽ¯ REAL-WORLD ANALOGY:                                                      â”‚
# â”‚ Like a bathroom lock - only one person at a time!                           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘                        STAGE 1: PARALLEL JOBS                           â•‘
  # â•‘                                                                         â•‘
  # â•‘  These jobs have NO "needs:" so they start SIMULTANEOUSLY!              â•‘
  # â•‘                                                                         â•‘
  # â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                             â•‘
  # â•‘  â”‚ ðŸ” Lint â”‚    â”‚ðŸ”’Securityâ”‚    â”‚ðŸ§ª Test â”‚  â† All start at same time   â•‘
  # â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â•‘
  # â•‘                                                                         â•‘
  # â•‘  ðŸ’¡ WHY PARALLEL?                                                       â•‘
  # â•‘  - Lint, Security, and Test don't depend on each other                  â•‘
  # â•‘  - Running together saves ~60 seconds vs sequential                     â•‘
  # â•‘  - Each gets its own fresh virtual machine (runner)                     â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 1: LINT - Code Quality Checks                                       â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY LINT?                                                            â”‚
  # â”‚ - Catches bugs before tests even run (faster feedback)                  â”‚
  # â”‚ - Enforces consistent code style across the team                        â”‚
  # â”‚ - Prevents "works on my machine" issues                                 â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸŽ¯ WHAT IT CHECKS:                                                      â”‚
  # â”‚ - Ruff: Python errors, unused imports, security issues                  â”‚
  # â”‚ - Formatting: Consistent code style                                     â”‚
  # â”‚ - File validation: YAML syntax, trailing whitespace                     â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest  # Use GitHub's free Linux servers

    steps:
      # Step 1: Get your code onto the runner
      # Without this, the runner has an empty folder!
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Python
      # The runner has Python, but we want a specific version
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # Step 3: Run the same pre-commit hooks that run locally
      # This ensures CI matches your local development
      - name: Run pre-commit hooks
        id: precommit  # This ID lets us check the result later
        uses: pre-commit/action@v3.0.1

      # Step 4: Create a nice summary in the GitHub Actions UI
      # "if: always()" means this runs even if pre-commit failed
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ” Lint & Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.precommit.outcome }}" == "success" ]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ruff Linter | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Ruff Formatter | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Import Sorting | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| File Validation | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Lint checks failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`pre-commit run --all-files\` locally to fix." >> $GITHUB_STEP_SUMMARY
          fi

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 2: SECURITY - Find Vulnerabilities                                  â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY SECURITY SCANNING?                                               â”‚
  # â”‚ - Catches security issues before hackers do                             â”‚
  # â”‚ - Checks your CODE (Bandit) and DEPENDENCIES (Safety)                   â”‚
  # â”‚ - Runs in parallel with lint (no "needs:")                              â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ” WHAT IT CHECKS:                                                      â”‚
  # â”‚ - Bandit: SQL injection, hardcoded passwords, exec() calls              â”‚
  # â”‚ - Safety: Known vulnerabilities in your pip packages                    â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  security:
    name: ðŸ”’ Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # Install security scanning tools (not in requirements.txt - CI only)
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      # Bandit scans your Python code for security issues
      # -ll = only show medium+ severity, -ii = only high+ confidence
      - name: Run Bandit (code security)
        id: bandit
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -ll -ii

      # Safety checks if your dependencies have known vulnerabilities
      # continue-on-error: true = don't fail the whole pipeline for warnings
      - name: Run Safety (dependency check)
        id: safety
        continue-on-error: true
        run: |
          safety check -r requirements.txt --output json > safety-report.json || true
          safety check -r requirements.txt || true

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | Python code security | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety | Dependency vulnerabilities | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | Secrets detection | âœ… (via pre-commit) |" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 3: TEST - Run Tests with Coverage                                   â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY NO "needs:"?                                                     â”‚
  # â”‚ - Tests run in parallel with lint and security (Stage 1)                â”‚
  # â”‚ - Faster feedback: all quality checks run simultaneously                â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ“Š COVERAGE EXPLAINED:                                                  â”‚
  # â”‚ - --cov=src = Measure which lines of code are tested                     â”‚
  # â”‚ - --cov-fail-under=80 = FAIL if less than 80% of code is tested         â”‚
  # â”‚ - 80% is arbitrary - teams choose 70-90% typically                      â”‚
  # â”‚                                                                         â”‚
  # â”‚ âš ï¸  100% COVERAGE â‰  BUG-FREE CODE!                                      â”‚
  # â”‚ You can have 100% coverage with bad tests. Coverage just means          â”‚
  # â”‚ "this line ran" not "this line is correct."                             â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      # â”‚ CACHING EXPLAINED                                                 â”‚
      # â”‚                                                                   â”‚
      # â”‚ ðŸ’¡ WHY CACHE?                                                     â”‚
      # â”‚ - pip install downloads packages from the internet (slow!)        â”‚
      # â”‚ - Caching saves them for next time (fast!)                        â”‚
      # â”‚ - First run: ~45 seconds. Cached run: ~15 seconds. 3x faster!     â”‚
      # â”‚                                                                   â”‚
      # â”‚ ðŸ”‘ HOW THE CACHE KEY WORKS:                                       â”‚
      # â”‚ - key: Linux-pip-abc123 (hash of requirements.txt)                â”‚
      # â”‚ - If requirements.txt changes â†’ new hash â†’ fresh download         â”‚
      # â”‚ - If unchanged â†’ reuse cached packages                            â”‚
      # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'  # Built-in pip caching
          cache-dependency-path: 'requirements.txt'

      # Additional cache layer for pip's download cache
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # The main event: run tests!
      # id: test-step lets us check if tests passed/failed later
      - name: Run tests with coverage
        id: test-step
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80 --alluredir=allure-results -v

      # Upload coverage to Codecov (external service for tracking trends)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false  # Don't fail if Codecov is down
          token: ${{ secrets.CODECOV_TOKEN }}

      # Save test results for the report job
      # Artifacts = files that persist after the job ends
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed (so we can see what broke)
        with:
          name: allure-results
          path: allure-results
          retention-days: 5  # Delete after 5 days to save storage

      # Show pass/fail in GitHub's UI
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-step.outcome }}" == "success" ]; then
            echo "âœ… **All tests passed with coverage â‰¥80%**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests failed or coverage below 80%**" >> $GITHUB_STEP_SUMMARY
          fi

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘                     STAGE 2: DOCKER (SEQUENTIAL)                        â•‘
  # â•‘                                                                         â•‘
  # â•‘  These jobs run AFTER all Stage 1 jobs pass!                            â•‘
  # â•‘                                                                         â•‘
  # â•‘       [lint] â”€â”€â”                                                        â•‘
  # â•‘                â”œâ”€â”€â†’ [check-changes] â”€â”€â†’ [docker-build] â”€â”€â†’ [smoke-test] â•‘
  # â•‘   [security] â”€â”€â”¤                                                        â•‘
  # â•‘                â”‚                                                        â•‘
  # â•‘       [test] â”€â”€â”˜                                                        â•‘
  # â•‘                                                                         â•‘
  # â•‘  ðŸ’¡ WHY SEQUENTIAL?                                                     â•‘
  # â•‘  - No point building Docker if lint/security/tests fail                 â•‘
  # â•‘  - Check changes first to skip unnecessary builds (saves time!)         â•‘
  # â•‘  - Smoke test only runs if Docker image was actually built              â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 4: CHECK CHANGES - Detect if Docker-related files changed           â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY A SEPARATE JOB?                                                  â”‚
  # â”‚ - Runs only after all quality gates pass                                â”‚
  # â”‚ - Outputs a flag so downstream jobs can skip if nothing changed         â”‚
  # â”‚ - Watches: Dockerfile, src/**, requirements.txt                         â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  check-changes:
    name: ðŸ”Ž Check Changes
    needs: [lint, security, test]
    runs-on: ubuntu-latest

    # Expose the output so docker-build and smoke-test can read it
    outputs:
      docker_changed: ${{ steps.changes.outputs.docker }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Docker-related changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            docker:
              - 'Dockerfile'
              - 'src/**'
              - 'requirements.txt'

      - name: Generate summary
        run: |
          echo "## ðŸ”Ž Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.docker }}" == "true" ]; then
            echo "âœ… Docker-related files changed â€” will build image" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ No Docker-related files changed â€” skipping build" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Watched paths: \`Dockerfile\`, \`src/**\`, \`requirements.txt\`" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 5: DOCKER BUILD - Build the Docker Image                            â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY?                                                                 â”‚
  # â”‚ - Validates the Dockerfile builds successfully                          â”‚
  # â”‚ - Uses GitHub Actions cache for fast rebuilds                           â”‚
  # â”‚ - Skipped if no Docker-related files changed                            â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¾ CACHING:                                                             â”‚
  # â”‚ - Uses GitHub Actions cache for Docker layers (type=gha)                â”‚
  # â”‚ - First build: ~60 seconds. Cached: ~15 seconds. 4x faster!             â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  docker-build:
    name: ðŸ³ Docker Build
    needs: [check-changes]
    if: needs.check-changes.outputs.docker_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Docker Buildx for advanced features and caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build the Docker image with GitHub Actions cache
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: simple-calculator:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Save the image as an artifact so the smoke-test job can use it
      - name: Save Docker image
        run: docker save simple-calculator:test -o /tmp/calculator-image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/calculator-image.tar
          retention-days: 1

      - name: Generate summary
        run: |
          echo "## ðŸ³ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Docker image built successfully!**" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 6: SMOKE TEST - Verify the Docker Image Works                       â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY A SEPARATE JOB?                                                  â”‚
  # â”‚ - Runs the calculator inside the container                              â”‚
  # â”‚ - Verifies the app actually works, not just that it builds              â”‚
  # â”‚ - Only runs if the Docker image was built                               â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  smoke-test:
    name: ðŸ’¨ Smoke Test
    needs: [docker-build]
    runs-on: ubuntu-latest

    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/calculator-image.tar

      # Run the calculator and verify the output
      - name: Run smoke test
        run: |
          echo "ðŸ§ª Running smoke test..."
          output=$(docker run --rm simple-calculator:test python -c "from src.calculator import Calculator; c = Calculator(); print(c.add(2, 3))")
          echo "Output: $output"

          if [ "$output" = "5.0" ]; then
            echo "âœ… Smoke test passed! Calculator is working correctly."
          else
            echo "âŒ Smoke test failed! Expected '5.0' but got '$output'"
            exit 1
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ’¨ Smoke Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Calculator works correctly inside Docker!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verified: \`2 + 3 = 5.0\`" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 7: REPORT - Generate Beautiful Test Reports                         â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY A SEPARATE JOB?                                                  â”‚
  # â”‚ - Report generation is slow (~30 seconds)                               â”‚
  # â”‚ - Even if tests fail, we want to see the report                         â”‚
  # â”‚ - "if: always()" ensures this runs regardless of test outcome           â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ“Š ALLURE FEATURES:                                                     â”‚
  # â”‚ - Tracks test history over time (see trends!)                           â”‚
  # â”‚ - Shows which tests are "flaky" (sometimes pass, sometimes fail)        â”‚
  # â”‚ - Generates beautiful HTML reports anyone can view                      â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  report:
    name: ðŸ“Š Report
    needs: [smoke-test]  # â† Waits for the full pipeline (test â†’ check â†’ build â†’ smoke)
    runs-on: ubuntu-latest
    if: always()  # Run even if smoke-test was skipped (no Docker changes)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download the test results saved by the test job
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      # Get previous reports from gh-pages branch (for history/trends)
      # continue-on-error: true = OK if gh-pages doesn't exist yet
      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages  # The branch where we store old reports
          path: gh-pages

      # Generate the HTML report with historical data
      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20  # Keep last 20 reports (delete older ones)

      # Debug: Check what was generated
      - name: Debug - Check generated reports
        run: |
          echo "ðŸ“‚ Checking allure-report directory:"
          ls -laR allure-report/ || echo "âŒ allure-report doesn't exist"
          echo ""
          echo "ðŸ“‚ Checking allure-history directory:"
          ls -laR allure-history/ || echo "âŒ allure-history doesn't exist"

      # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      # â”‚ BUILD COMPLETE SITE STRUCTURE                                       â”‚
      # â”‚                                                                     â”‚
      # â”‚ ðŸ’¡ COMBINING EVERYTHING:                                            â”‚
      # â”‚ We build a site that includes:                                      â”‚
      # â”‚ - Landing page at root (/)                                          â”‚
      # â”‚ - Learning UI at /learn                                             â”‚
      # â”‚ - Allure reports at /allure                                         â”‚
      # â”‚ - Assets directory for shared resources                             â”‚
      # â”‚                                                                     â”‚
      # â”‚ This ensures the test deployment preserves the learning UI!         â”‚
      # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      - name: Build complete site structure
        run: |
          echo "ðŸ“¦ Building complete site with Allure at /allure..."

          # Debug: Check what directories exist
          echo "ðŸ” Checking available directories:"
          ls -la
          echo ""

          # Create site directory
          mkdir -p _site

          # Copy landing page
          cp docs/index.html _site/
          echo "âœ… Copied landing page"

          # Copy learning UI
          cp -r docs/learn _site/
          echo "âœ… Copied learning UI"

          # Copy Allure reports to /allure subdirectory
          # The allure-report-action creates numbered directories (e.g., /61/, /62/)
          mkdir -p _site/allure

          # Check if allure-history exists and copy ALL numbered reports
          if [ -d "allure-history" ] && [ "$(ls -A allure-history)" ]; then
            # Copy all numbered report directories
            cp -r allure-history/* _site/allure/
            echo "âœ… Copied all Allure report versions from allure-history"

            # Find the latest report number (highest number)
            LATEST_REPORT=$(ls -1v allure-history | grep '^[0-9]*$' | tail -1)

            if [ -n "$LATEST_REPORT" ]; then
              echo "ðŸ“Š Latest report number: $LATEST_REPORT"

              # Copy the latest report to the root of /allure/ (so /allure/ works directly)
              if [ -d "allure-history/$LATEST_REPORT" ]; then
                cp -r allure-history/$LATEST_REPORT/* _site/allure/
                echo "âœ… Copied latest report (#$LATEST_REPORT) to /allure/ root"
              fi
            else
              echo "âš ï¸  Warning: Could not find numbered report directory"
            fi

          # Fallback to allure-report (first run or if history fails)
          elif [ -d "allure-report" ] && [ "$(ls -A allure-report)" ]; then
            cp -r allure-report/* _site/allure/
            echo "âœ… Copied Allure reports from allure-report (first run)"
          else
            echo "âŒ ERROR: Neither allure-history nor allure-report found!"
            echo "ðŸ“‚ Available directories:"
            ls -la
            exit 1
          fi

          # Copy assets (now in docs/assets)
          cp -r docs/assets _site/
          echo "âœ… Copied assets"

          # Copy guides for relative links from learning UI
          if [ -d "guides" ]; then
            cp -r guides _site/
            echo "âœ… Copied guides"
          fi

          # Create .nojekyll to prevent GitHub Pages from processing files
          touch _site/.nojekyll
          echo "âœ… Created .nojekyll file"

          echo "ðŸŽ‰ Complete site structure ready!"
          echo ""
          echo "ðŸ“‚ Site structure:"
          ls -la _site
          echo ""
          echo "ðŸ“‚ Allure directory contents:"
          ls -la _site/allure/ || echo "âŒ Allure directory is empty or doesn't exist"
          echo ""
          echo "ðŸ“‚ Checking for index.html in allure root:"
          if [ -f "_site/allure/index.html" ]; then
            echo "âœ… Found index.html at /allure/index.html (main entry point)"
          else
            echo "âŒ ERROR: index.html missing from /allure/ root!"
            echo "This means the landing page link to /allure/ will 404"
            exit 1
          fi
          echo ""
          echo "ðŸ“‚ Numbered report directories in /allure/:"
          ls -1 _site/allure/ | grep '^[0-9]*$' || echo "No numbered directories found"

      # Prepare the complete site for GitHub Pages deployment
      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ JOB 8: DEPLOY - Publish to GitHub Pages                                 â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸ’¡ WHY THIS CONDITIONAL?                                                â”‚
  # â”‚ - github.ref == 'refs/heads/main' = Only deploy from main branch        â”‚
  # â”‚ - github.event_name != 'pull_request' = Don't deploy PRs                â”‚
  # â”‚                                                                         â”‚
  # â”‚ ðŸŽ¯ RESULT:                                                              â”‚
  # â”‚ - PR opened â†’ Tests run, but NO deploy (just preview)                   â”‚
  # â”‚ - PR merged to main â†’ Tests run AND deploy                              â”‚
  # â”‚ - This prevents half-finished features from going live!                 â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  deploy:
    name: ðŸš€ Deploy
    needs: [report]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    # Connect to GitHub Pages environment (shows deployment URL in GitHub UI)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Generate summary
        run: |
          echo "## ðŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Successfully deployed to GitHub Pages!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ  [Landing Page](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Allure Reports](${{ steps.deployment.outputs.page_url }}allure/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š [Learning UI](${{ steps.deployment.outputs.page_url }}learn/)" >> $GITHUB_STEP_SUMMARY
